## Автоматизация регистрации пользователей в ZENLIX  средствами R

### Стандартная регистрация
Сотрудники [нашей организации](http://e-tpp.org) работают с обращениями клиентов в системе обработки электронных заявок [ZENLIX v2.95](https://ru.zenlix.com/support/v295/obshchiy-princip-raboty-sistem). Для получения доступа к системе новые клиенты проходят процедуру регистрации. К сожалению, средствами самой системы нельзя изменить [стандартную регистрационную форму](https://ru.zenlix.com/support/v295/registraciya-polzovatelya), обязательными полями которой являются только *имя* и *email* клиента. Это очень неудобно с точки зрения сбора информации о клиенте и предприятии, которое он представляет. Правда, внутри самой системы профиль пользователя можно расширить за счет т.н. [дополнительных полей](https://ru.zenlix.com/support/v295/registraciya-polzovatelya), создаваемых администратором. Однако клиенты, как правило, после первичной регистрации такие поля не заполняют, поэтому проблема наполнения клиентской базы таким образом не решается.

### Формулировка задачи
Мы поставили задачу разработать механизм сбора по установленной форме, обработки и сохранения расширенной информации о новом клиенте на этапе его регистрации без изменения кода системы ZENLIX.

### Альтернативный подход
Альтернативу стандартной процедуре регистрации мы реализовали на основе открытых сервисов Google. Так, на первом этапе клиенты заполняли специально разработанную нами [многоуровневую Google form](https://docs.google.com/forms/d/e/1FAIpQLSeoVtfR2G0xCI2aqnWvQSeFQUQnt43xpvDDJLHBs3n0uiq2jA/viewform?hl=uk), ответы из которой [сохранялись в Google spreadsheet](https://support.google.com/docs/answer/2917686?hl=ru). Затем администратор [создавал нового пользователя](https://ru.zenlix.com/support/v295/dobavlenieizmenenie-polzovatelya) средствами системы ZENLIX, и переносил в его профиль анкетные данные из Google spreadsheet.

### Автоматизация процесса
С ростом количества клиентов возник вопрос автоматизации процесса. С помощью скрипта на языке ```R``` и стандартных средств Windows мы перешли к новой схеме (последовательности) регистрации клиента в системе:

* заполнение формы и первичная [валидация данных](https://support.google.com/docs/answer/3378864?hl=en) ->
* автоматический перенос ответов из Google form в Google spreadsheet ->
* проверка анкетных данных модератором ->
* работа R-script по созданию нового пользователя, наполнению его профиля и отправке уведомления ->

При этом запуск R-script осуществляется по расписанию через [планировщик Windows](https://technet.microsoft.com/ru-ru/library/cc721931(v=ws.11).aspx)

##### Общая схема регистрации пользователей
![автоматизация регистрации пользователей](https://raw.githubusercontent.com/woldemarg/zenlix_registration/master/zen_reg_diagram.png)

### Преимущества и недостатки
Предложенный механизм позволяет разработать и использовать регистрационную форму любого уровня сложности (на основе сервиса Google). Добавление пользователя через R-script реализуется средствами самой системы (через эмуляцию действий администратора с помощью библиотеки [RSelenium](https://cran.r-project.org/web/packages/RSelenium/RSelenium.pdf)), а перенос информации из Google spreadsheet в *БД phpmyadmin* - с помощью запросов на языке ```SQL```. Это позволяет не менять ([открытый](https://ru.zenlix.com/support/v295/poluchenie-i-tip-licenzii)) код системы и избежать сбоев в ее работе. Кроме того, сотрудники организации имеют доступ к полноценной БД анкетных данных клиентов (*shared spreadsheet*) также и вне системы ZENLIX.

Однако для работы R-script необходимо выделить ПК с установленным ```R``` и другим ПО согласно техническим требованиям (см. ниже).

### Технические требования
Для автоматизации регистрации пользователей следует предварительно настроить сервисы Google и подготовить рабочий ПК для запуска R-script, а именно: 
1. Установить ```R``` (текущая версия [R-3.3.3](https://cran.r-project.org/)) и загрузить дополнительные библиотеки (см. ниже)
2. Для переноса данных из Google Form в Google spreadsheet - настроить [сохранение ответов](https://support.google.com/docs/answer/2917686?hl=ru) в таблице 
3. Для импорта данных из таблицы в ```R``` - [получить shareable link](https://support.google.com/docs/answer/2494822#link_sharing) на файл
4. Для запуска из ```R``` и работы c Selenium Server - 
	* [загрузить geckodriver.exe](https://github.com/mozilla/geckodriver/releases) и прописать путь к файлу в системной переменной PATH
	* [скачать файл selenium-server-standalone-3.0.1.jar](selenium-server-standalone-3.0.1.jar) и поместить в папку проекта
	* установить бесплатный [веб-браузер Firefox](https://www.mozilla.org/ru/firefox/new/)
	* [установить Java](https://java.com/ru/download/) и прописать путь к файлу *java.exe* в системной переменной PATH 
5. Для остановки Selenium Server из ```R``` - загрузить [curl.exe](https://curl.haxx.se/download.html) и прописать путь к файлу в системной переменной PATH (при этом **важно** работать с именно с файлом selenium-server-standalone-3.0.1.jar)
6. Для [запуска R-script из bat-файла](http://stackoverflow.com/questions/6788928/how-to-run-a-r-language-r-file-using-batch-file) - прописать путь к RScript.exe в системной переменной PATH (*например, D:\Install\R\R-3.3.3\bin\x64*)

>**Примечание.** Если [проблема с запуском Selenium Server через rsDriver()](https://github.com/woldemarg/zenlix_registration/issues/1) не возникает, то необходимости в совершении действий пп.4-5 нет. 

### Библиотеки R
Минимальный набор сторонних библиотек:
```R
library(gsheet) #импорт данных
library(DBI) #для работы RMySQL
library(RMySQL) #работа с БД phpmyadmin
library(RSelenium) #навигация в Интернет
library(mailR) #рассылка почты
```

### Алгоритм R-script
Общая последовательность такая:
1. загрузка "промодерированных" анкет из Google spreadsheet
2. выборка ранее не зарегистрированных пользователей
3. если есть новые пользователи:
4. -- старт Selenium Server и вход в систему под администратором
5. -- -- цикл для каждого нового пользователя:
6. -- -- -- -- обработка данных и генерация пароля
7. -- -- -- -- создание профиля средствами системы
8. -- -- -- -- добавление данных в *users* и *user_data* через ```SQL```-запросы
9. -- -- -- -- если ошибка на п.8
10. -- -- -- -- -- отмена предыдущих транзакций (п.7 и п.8) 
11. -- -- -- -- -- иначе: отправка письма-уведомления
12. -- -- конец цикла
13. -- остановка Selenium Server и выход из программы


>**Примечание 1.** Подробные комментарии приведены внутри кода в файле *zen_reg.R*, доступного в [этом репозитории](https://github.com/woldemarg/zenlix_registration).
>
>**Примечание 2.** Первая проверка на уникальность логина (email) нового пользователя реализована в электронной таблице через [функцию поиска дубликатов](https://productforums.google.com/forum/#!topic/docs/IDRsyJWM7yc;context-place=topicsearchin/docs/category$3Ahow-do-i%7Csort:relevance%7Cspell:false)
>
>**Примечание 3.** Автоматический запуск R-script из bat-файла по расписанию реализован через [создание задачи в планировщике Windows](http://stackoverflow.com/questions/2793389/scheduling-r-script). В связи с необходимостью работы на ПК с разными сетевыми настройками bat-файл можно запускать с аргументами "atHome" и "atWork" 

### Итоги и перспективы
Таким образом, без привлечения сторонних разработчиков и изменения кода системы ZENLIX на основе бесплатного ПО (кроме *планировщика Windows*) и открытых сервисов Google средствами языка ```R``` создан механизм, который обеспечивает полноценный сбор сведений (и их перенос) о клиенте в момент регистрации. Преимуществом такого подхода является промежуточная сводная таблицу с анкетными данными клиентов (Google spreadsheet), которую иначе из системы можно получить только путем объединения таблиц *users* и *user_data*.

Если решить [проблемы кодировки](https://github.com/woldemarg/zenlix_registration/issues/2) и [работы на ПК в корпоративной сети](https://github.com/woldemarg/zenlix_registration/issues/1), то R-script можно существенно оптимизировать и перейти к рассылке писем на основе *markdown* или *html* разметки. 
