## Автоматизация регистрации пользователей в ZENLIX

### Стандартная регистрация
Сотрудники [нашей организации](http://e-tpp.org) работают с клиентами в системе обработки электронных заявок [ZENLIX v2.95](https://ru.zenlix.com/support/v295/obshchiy-princip-raboty-sistem). Перед входом в систему новые клиенты проходят процедуру регистрации. К сожалению, средствами самой системы нельзя отредактировать [стандартную регистрационную форму]( https://ru.zenlix.com/support/v295/registraciya-polzovatelya), обязательными полями которой являются только *имя* и *еmail* клиента. При этом подробную информацию о клиенте в системе можно хранить в т.н. [дополнительных полях](https://ru.zenlix.com/support/v295/registraciya-polzovatelya) его профиля, создаваемых администратором. Как правило, сами клиенты после регистрации не заполняют такие поля, что усложняет последующую работу с ними.

### Формулировка задачи
Организовать сбор, обработку и сохранение расширенной информации о новом клиенте по установленной форме на этапе его регистрации в системе.

### Альтернативый подход
Новый подход к регистрации клиентов мы реализовали на основе открытых сервисов Google. Так, на первом этапе клиенты заполняли специально разработанную нами [многоуровневую форму](https://docs.google.com/forms/d/e/1FAIpQLSeoVtfR2G0xCI2aqnWvQSeFQUQnt43xpvDDJLHBs3n0uiq2jA/viewform?hl=uk), ответы из которой [сохранялись в таблицу](https://support.google.com/docs/answer/2917686?hl=ru). Затем администратор [создавал нового пользователя](https://ru.zenlix.com/support/v295/dobavlenieizmenenie-polzovatelya) средствами самой системы, и переносил в его профиль сведения из анкеты.

### Автоматизация процесса
С ростом количества клиентов возник вопрос усовершенствования альтернативного подхода. С помощью скрипта на языке ```R``` и стандартных средств автоматизации Windows мы перешли к такой схеме регистрации клиента:

* заполнение формы (с настройками [валидации данных](https://support.google.com/docs/answer/3378864?hl=en)) ->
* автоматический перенос ответов в таблицу ->
* проверка анкетных данных модератором ->
* работа R-script по созданию пользователя, наполнению его профиляи и отправке уведомления ->
* запуск R-script по расписанию через [планировщик Windows](https://technet.microsoft.com/ru-ru/library/cc721931(v=ws.11).aspx)

### Преимущества и недостатки
Предложенная схема позволяет разработать и использовать регистрационную форму любого уровня сложности (на основе сервисов Google). Добавление пользователя через R-script реализуется средствами самой системы (через эмуляцию действий администратора), а перенос информации из анкет в *БД phpmyadmin* - с помощью ```SQL```. Это позволяет не менять ([открытый](https://ru.zenlix.com/support/v295/poluchenie-i-tip-licenzii)) код системы и избежать сбоев в ее работе. Кроме того, сотрудники организации имеют доступ к с полноценной БД анкетных данных клиентов (через *shared spreadsheet*) вне системы ZENLIX.

При этом для работы R-script необходимо выделить ПК с установленным ```R``` (+ библиотеки), а также обеспечить на нем и в настройках сервисов Google соответствие определенным техническим требованиям.

### Tехнические требования
1. Установить ```R``` (текущая версия [R-3.3.3](https://cran.r-project.org/))
2. Для переноса данных из Google Form - настроить [сохранение ответов](https://support.google.com/docs/answer/2917686?hl=ru) в электронной таблице  
3. Для работы с анкетными данными из ```R``` - электронную таблицу [опубликовать в Интернет](https://support.google.com/docs/answer/37579?hl=ru)
4. Для запуска и работы c [Selenium Server](https://cran.r-project.org/web/packages/RSelenium/RSelenium.pdf) из ```R``` - 
* [загрузить geckodriver.exe](https://github.com/mozilla/geckodriver/releases) и прописать путь к файлу в переменной PATH
* установить бесплатный [веб-браузер Firefox](https://www.mozilla.org/ru/firefox/new/)
5. Для остановки Selenium Server из ```R``` - загрузить [curl.exe](https://curl.haxx.se/download.html) и прописать путь к файлу в переменной PATH
6. Для [запуска R-sript из bat-файла](http://stackoverflow.com/questions/6788928/how-to-run-a-r-language-r-file-using-batch-file) - прописать путь к R.exe в переменной PATH (*например, D:\Install\R\R-3.3.3\bin\x64*)

>**Примечание.** Если решить [проблему с запуском Selenium Server через rsDriver()](https://github.com/woldemarg/zenlix_registration/issues/1) -необходимость в совершении дейсвий по пп.4-5 отпадает. 

### Библиотеки R
Для ускорения работы R-script используется минимальный набор сторонних библиотек:
```R
library(DBI)       #для работы RMySQL
library(RMySQL)    #работа с БД phpmyadmin
library(RSelenium) #навигация в Интернет
library(mailR)     #рассылка почты
```

### Алгоритм R-script
Общая последовательность такая:
1. -- загрузка проверенных анкет из электронной таблицы
2. -- выборка ранее не зарегистрированных пользователей
3. -- если есть новые пользователи:
4. -- -- старт Selenium Server и вход в систему под администратором
5. -- -- для каждого нового пользователя:
6. -- -- -- -- создание профиля средствами системы
7. -- -- -- -- добавление данных в *users* и *user_data* через ```SQL```-запросы
8. -- -- -- -- если ошибка на п.7
9. -- -- -- -- -- отмена предыдущих транзакций (п.6 и п.7) 
9. -- -- -- -- -- иначе: отправка письма-уведомления
10. -- -- остановка Selenium Server и выход из программы
11. -- -- иначе: выход из программы

>**Примечание 1.** Подробные комментарии приведены прямо внутри кода в файле *zen_reg.R*
>
>**Примечание 2.** Первая проверка на уникальность логина (email) нового пользователя реализована в электронной таблице через [функцию поиска дубликатов](https://productforums.google.com/forum/#!topic/docs/IDRsyJWM7yc;context-place=topicsearchin/docs/category$3Ahow-do-i%7Csort:relevance%7Cspell:false)
>
>**Примечание 3.** Автоматический запуск R-script по расписанию реализован через [создание задачи в плаировщике Windows](http://stackoverflow.com/questions/2793389/scheduling-r-script) 
 

